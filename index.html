<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kripto Replay & Live (Tek Grafik Tam Ekran)</title>
<script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
body { margin:0; background:#1e1e1e; color:#eee; font-family:system-ui; }
#controls { display:flex; flex-wrap:wrap; align-items:center; gap:8px; padding:12px; background:#2c1a5a; border-bottom:1px solid #333; border-radius:8px 8px 0 0; }
input, select { background:#3a2b72; color:#fff; border:none; border-radius:6px; padding:6px 8px; font-size:14px; }
button { background:#9c27b0; color:#fff; border:none; border-radius:6px; padding:6px 10px; font-size:14px; cursor:pointer; }
#chartContainer { width:calc(100% - 16px); margin:8px; height:calc(100vh - 150px); display:flex; flex-direction:column; border-radius:12px; overflow:hidden; }
.chartPanel { flex:1; margin:4px 0; border-radius:12px; overflow:hidden; background:#000; position:relative; }
.singleFullscreenBtn { position:absolute; top:5px; right:5px; z-index:10; background:#9c27b0; padding:4px 6px; font-size:12px; border-radius:4px; cursor:pointer; }
#sliderContainer { width:calc(100% - 16px); display:flex; align-items:center; gap:4px; margin:8px; padding:0 8px; }
#timeline { width:100%; }
.status { margin-left:auto; color:#0f0; font-weight:600; }
</style>
</head>
<body>

<div id="controls">
  <label>Coin: <input id="coin" value="BTCUSDT"></label>
  <label>Periyot:
    <select id="interval">
      <option>1m</option>
      <option>5m</option>
      <option>15m</option>
      <option>1h</option>
      <option>4h</option>
      <option>1d</option>
    </select>
  </label>
  <label>Ba≈ülangƒ±√ß: <input type="date" id="startDate"></label>
  <label>Biti≈ü: <input type="date" id="endDate"></label>
  <label>Hƒ±z:
    <select id="speed">
      <option value="1">1x</option>
      <option value="0.5">0.5x</option>
      <option value="2">2x</option>
      <option value="4">4x</option>
    </select>
  </label>
  <button id="replayBtn">üé¨ Replay</button>
  <button id="pauseBtn">‚è∏Ô∏è Durdur</button>
  <button id="rewindBtn">‚è™ Geri Sar</button>
  <button id="stopBtn">‚èπÔ∏è Stop</button>
  <button id="liveBtn">üî¥ Live</button>
  <div class="status" id="status">Hazƒ±r</div>
</div>

<div id="sliderContainer">
  <input type="range" id="timeline" min="0" max="0" value="0">
</div>

<div id="chartContainer">
  <div id="chart" class="chartPanel">
    <button class="singleFullscreenBtn">‚õ∂</button>
  </div>
</div>

<script>
// Grafik ve seri olu≈üturma
const chartEl = document.getElementById("chart");
let chart, candleSeries;
let priceLine = null;
let ws = null;
let replayData = [];
let replayIndex = 0, replayTimer = null, isPaused = false, mode="idle";
const statusEl = document.getElementById("status");
const timeline = document.getElementById("timeline");
const speedSelect = document.getElementById("speed");

function logStatus(txt,color="#0f0"){
  statusEl.style.color = color;
  statusEl.textContent = txt;
}

function createChart(){
  if(chart) chart.remove();
  chart = LightweightCharts.createChart(chartEl, {
    layout: { background: { color:'#000' }, textColor:'#DDD' },
    grid: { vertLines:{color:'#222'}, horzLines:{color:'#222'} },
    timeScale: { timeVisible:true, secondsVisible:false, rightOffset:3, barSpacing:6 },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
  });
  candleSeries = chart.addCandlestickSeries({
    upColor:'#42a5f5', downColor:'#ef9a9a',
    borderUpColor:'#42a5f5', borderDownColor:'#ef9a9a',
    wickUpColor:'#42a5f5', wickDownColor:'#ef9a9a'
  });
}

function updateLastPrice(series, prevClose, newClose, currentPriceLine){
  const color = newClose >= prevClose ? '#00ff00' : '#ff0000';
  if(!currentPriceLine){
    return series.createPriceLine({
      price: newClose, color, lineWidth:2, lineStyle:LightweightCharts.LineStyle.Solid,
      axisLabelVisible:true, title:'Last'
    });
  }
  currentPriceLine.applyOptions({ price: newClose, color });
  return currentPriceLine;
}

async function fetchData(symbol, interval, start=0, end=0, limit=1000){
  let url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  if(start && end) url += `&startTime=${start}&endTime=${end}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.map(k => ({
    time: k[0]/1000,
    open: +k[1], high: +k[2], low: +k[3], close: +k[4]
  }));
}

// Replay fonksiyonu
async function startReplay(){
  stopReplay();
  if(ws) ws.close();
  mode = "replay";
  logStatus("Veri √ßekiliyor...", "#ff0");

  const coin = document.getElementById("coin").value.toUpperCase();
  const interval = document.getElementById("interval").value;
  const start = new Date(document.getElementById("startDate").value).getTime();
  const end = new Date(document.getElementById("endDate").value).getTime();
  if(!start || !end) return alert("Tarih se√ß!");

  replayData = await fetchData(coin, interval, start, end);
  if(!replayData.length) return logStatus("Veri yok", "#f00");

  createChart();
  replayIndex = 0;
  timeline.max = replayData.length - 1;

  candleSeries.setData([replayData[0]]);
  priceLine = updateLastPrice(candleSeries, replayData[0].open, replayData[0].close, priceLine);
  replayIndex = 1;

  playReplay();
}

function playReplay(){
  if(!replayData.length) return;
  const speed = parseFloat(speedSelect.value);
  isPaused = false;
  clearInterval(replayTimer);
  replayTimer = setInterval(() => {
    if(isPaused) return;
    if(replayIndex >= replayData.length){
      stopReplay();
      return;
    }

    const c = replayData[replayIndex];
    const prev = replayData[replayIndex-1]?.close || c.open;

    candleSeries.update(c);
    priceLine = updateLastPrice(candleSeries, prev, c.close, priceLine);

    replayIndex++;
    timeline.value = replayIndex;
  }, 1000/speed);
}

function pauseReplay(){
  isPaused = !isPaused;
  document.getElementById("pauseBtn").textContent = isPaused ? "‚ñ∂Ô∏è Devam" : "‚è∏Ô∏è Durdur";
  logStatus(isPaused ? "Durduruldu" : "Devam", "#ff0");
}
function stopReplay(){
  clearInterval(replayTimer);
  replayTimer = null;
  replayIndex = 0;
  logStatus("Replay durdu", "#f00");
}
function rewindReplay(){
  if(mode !== "replay") return;
  replayIndex = Math.max(0, replayIndex - 10);
  candleSeries.setData(replayData.slice(0, replayIndex + 1));
  timeline.value = replayIndex;
}
timeline.oninput = () => {
  if(mode === "replay"){
    replayIndex = parseInt(timeline.value);
    candleSeries.setData(replayData.slice(0, replayIndex + 1));
  }
}

// Live fonksiyonu
async function startLive(){
  stopReplay();
  mode = "live";
  logStatus("Canlƒ± mod ba≈ülatƒ±lƒ±yor...", "#ff0");
  const coin = document.getElementById("coin").value.toUpperCase();
  const interval = document.getElementById("interval").value;
  createChart();

  let data = await fetchData(coin, interval, 0, 0, 500);
  candleSeries.setData(data);
  priceLine = updateLastPrice(candleSeries, data.at(-1).close, data.at(-1).close, priceLine);

  if(ws) ws.close();
  ws = new WebSocket(`wss://stream.binance.com:9443/ws/${coin.toLowerCase()}@kline_${interval}`);
  ws.onmessage = e => {
    const k = JSON.parse(e.data).k;
    const c = {
      time: k.t/1000,
      open: +k.o, high: +k.h, low: +k.l, close: +k.c
    };
    const prev = data.at(-1)?.close || c.open;
    if(data.at(-1)?.time === c.time){
      data[data.length-1] = c;
    } else {
      data.push(c);
      if(data.length > 500) data.shift();
    }
    candleSeries.update(c);
    priceLine = updateLastPrice(candleSeries, prev, c.close, priceLine);
  };

  chart.timeScale().scrollToRealTime();
  logStatus("Canlƒ± mod √ßalƒ±≈üƒ±yor", "#0f0");
}

// Tam ekran modu (tek grafik)
let enlarged = null;
document.querySelectorAll('.singleFullscreenBtn').forEach(btn => {
  btn.onclick = () => {
    const parent = btn.parentElement;
    if(enlarged === parent){
      // Normal boyuta d√∂n
      parent.style.position = "";
      parent.style.width = "";
      parent.style.height = "";
      parent.style.zIndex = "";
      parent.style.background = "#000";
      parent.style.display = "flex";
      enlarged = null;
      btn.textContent = "‚õ∂";
    } else {
      // Tam ekrana ge√ß
      parent.style.position = "fixed";
      parent.style.top = "0";
      parent.style.left = "0";
      parent.style.width = "100%";
      parent.style.height = "100%";
      parent.style.zIndex = "999";
      enlarged = parent;
      btn.textContent = "‚ùé";
    }
  }
});

// Butonlara i≈ülev atama
document.getElementById("replayBtn").onclick = startReplay;
document.getElementById("pauseBtn").onclick = pauseReplay;
document.getElementById("stopBtn").onclick = stopReplay;
document.getElementById("rewindBtn").onclick = rewindReplay;
document.getElementById("liveBtn").onclick = startLive;
</script>
</body>
</html>
