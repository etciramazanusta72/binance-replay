<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kripto Replay & Live (v3.2)</title>
  <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body {
      background-color: #0e0e0e;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1b1b1b;
      padding: 10px 20px;
      height: 60px;
      flex-wrap: wrap;
    }
    button, select, label {
      background: #333;
      color: #fff;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 5px;
      transition: 0.2s;
    }
    button:hover, select:hover, label:hover {
      background: #555;
    }
    #chart {
      height: calc(100vh - 60px - 40px);
      width: 100vw;
    }
    #modeLabel {
      margin-left: 10px;
      color: #22ab94;
      font-weight: bold;
    }
    input[type="checkbox"] {
      accent-color: #22ab94;
      transform: scale(1.2);
      margin-right: 3px;
    }
    /* === Alt ÅŸerit === */
    #infoBar {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #1b1b1b;
      color: #fff;
      padding: 8px 0;
      font-family: Arial, sans-serif;
      font-size: 14px;
      border-top: 1px solid #333;
    }
    #infoBar span {
      font-weight: bold;
      color: #22ab94;
    }
    #infoBar span#priceChange {
      color: #f39c12;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div>
      <select id="symbolSelect" onchange="changeSymbol(this.value)">
        <option value="BTCUSDT">BTC/USDT</option>
        <option value="ETHUSDT">ETH/USDT</option>
        <option value="BNBUSDT">BNB/USDT</option>
      </select>

      <button onclick="changeInterval('1m')">1m</button>
      <button onclick="changeInterval('5m')">5m</button>
      <button onclick="changeInterval('15m')">15m</button>
      <button onclick="changeInterval('1h')">1h</button>
      <button onclick="changeInterval('4h')">4h</button>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
      <label><input type="checkbox" id="toggleEMA" checked onchange="toggleEMA()">EMA (20)</label>
      <label><input type="checkbox" id="toggleSMA" checked onchange="toggleSMA()">SMA (50)</label>

      <label for="replaySpeed">HÄ±z:</label>
      <select id="replaySpeed" onchange="updateReplaySpeed(this.value)">
        <option value="1">1x</option>
        <option value="2">2x</option>
        <option value="5">5x</option>
      </select>

      <button onclick="toggleMode()">Replay / Live</button>
      <span id="modeLabel">Live</span>
    </div>
  </div>

  <div id="chart"></div>

  <!-- === Alt bilgi ÅŸeridi === -->
  <div id="infoBar">
    <span id="lastPrice">Fiyat: -</span>
    <span id="priceChange">DeÄŸiÅŸim: -</span>
    <span id="candleTime">Zaman: -</span>
  </div>

  <script>
    let chart, candleSeries, emaSeries, smaSeries, socket;
    let currentSymbol = "BTCUSDT";
    let currentInterval = "15m";
    let liveMode = true;
    let lastPriceLine = null;
    let replayIndex = 0;
    let replayData = [];
    let replayTimer = null;
    let replaySpeed = 1;
    let showEMA = true;
    let showSMA = true;

    // === EMA / SMA ===
    function ema(data, period) {
      const k = 2 / (period + 1);
      let emaArray = [];
      let prevEma;
      for (let i = 0; i < data.length; i++) {
        const close = data[i].close;
        if (i < period - 1) {
          emaArray.push({ time: data[i].time, value: null });
          continue;
        }
        if (i === period - 1) {
          const sum = data.slice(0, period).reduce((s, d) => s + d.close, 0);
          prevEma = sum / period;
        } else {
          prevEma = close * k + prevEma * (1 - k);
        }
        emaArray.push({ time: data[i].time, value: prevEma });
      }
      return emaArray;
    }

    function sma(data, period) {
      return data.map((d, i) => {
        if (i < period - 1) return { time: d.time, value: null };
        const avg = data.slice(i - period + 1, i + 1).reduce((sum, x) => sum + x.close, 0) / period;
        return { time: d.time, value: avg };
      });
    }

    // === Chart BaÅŸlatma ===
    function initChart() {
      if (chart) {
        chart.remove();
        chart = null;
      }

      chart = LightweightCharts.createChart(document.getElementById("chart"), {
        layout: { background: { color: "#0e0e0e" }, textColor: "#d1d4dc" },
        grid: { vertLines: { color: "#1e222d" }, horzLines: { color: "#1e222d" } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: "#485c7b" },
        timeScale: { borderColor: "#485c7b" },
      });

      candleSeries = chart.addCandlestickSeries();
      emaSeries = chart.addLineSeries({ color: "#22ab94", lineWidth: 1.5 });
      smaSeries = chart.addLineSeries({ color: "#f39c12", lineWidth: 1.5 });
    }

    async function fetchHistoricalData(symbol, interval) {
      const res = await fetch(
        `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=500`
      );
      const data = await res.json();
      return data.map(k => ({
        time: k[0] / 1000,
        open: parseFloat(k[1]),
        high: parseFloat(k[2]),
        low: parseFloat(k[3]),
        close: parseFloat(k[4]),
      }));
    }

    // === Replay ===
    async function startReplay(interval) {
      cleanup();
      liveMode = false;
      document.getElementById("modeLabel").innerText = "Replay";

      initChart();
      replayData = await fetchHistoricalData(currentSymbol, interval);
      const emaData = ema(replayData, 20);
      const smaData = sma(replayData, 50);
      candleSeries.setData([]);
      emaSeries.setData([]);
      smaSeries.setData([]);
      replayIndex = 0;

      const step = 200 / replaySpeed;
      replayTimer = setInterval(() => {
        if (replayIndex < replayData.length) {
          const c = replayData[replayIndex];
          candleSeries.update(c);
          const prevClose = replayIndex > 0 ? replayData[replayIndex - 1].close : c.close;
          updateLastPrice(c.close, prevClose, c.time);
          if (showEMA) emaSeries.update(emaData[replayIndex]);
          if (showSMA) smaSeries.update(smaData[replayIndex]);
          replayIndex++;
        } else {
          clearInterval(replayTimer);
        }
      }, step);
    }

    // === Live ===
    function startLive(interval = "15m") {
      cleanup();
      liveMode = true;
      document.getElementById("modeLabel").innerText = "Live";

      initChart();

      fetchHistoricalData(currentSymbol, interval).then(data => {
        candleSeries.setData(data);
        if (showEMA) emaSeries.setData(ema(data, 20));
        if (showSMA) smaSeries.setData(sma(data, 50));
        const last = data[data.length - 1];
        const prev = data[data.length - 2] || last;
        updateLastPrice(last.close, prev.close, last.time);
      });

      socket = new WebSocket(`wss://stream.binance.com:9443/ws/${currentSymbol.toLowerCase()}@kline_${interval}`);

      socket.onmessage = event => {
        if (!candleSeries) return;
        const data = JSON.parse(event.data);
        const k = data.k;
        const candle = {
          time: Math.floor(k.t / 1000),
          open: parseFloat(k.o),
          high: parseFloat(k.h),
          low: parseFloat(k.l),
          close: parseFloat(k.c),
        };
        const prevClose = candleSeries.data[candleSeries.data.length - 1]?.close || candle.close;
        candleSeries.update(candle);
        updateLastPrice(candle.close, prevClose, candle.time);
      };

      socket.onclose = () => {
        console.warn("ðŸ”Œ BaÄŸlantÄ± koptu, yeniden baÄŸlanacak...");
        setTimeout(() => {
          if (liveMode) startLive(interval);
        }, 5000);
      };
    }

    // === Bilgi Åžeridi GÃ¼ncelle ===
    function updateLastPrice(price, prevClose = null, time = null) {
      if (!chart || !candleSeries) return;

      if (lastPriceLine) candleSeries.removePriceLine(lastPriceLine);
      lastPriceLine = candleSeries.createPriceLine({
        price: price,
        color: "#22ab94",
        lineWidth: 2,
        lineStyle: LightweightCharts.LineStyle.Solid,
        axisLabelVisible: true,
        title: `Last: ${price.toFixed(2)}`,
      });

      document.getElementById("lastPrice").innerText = `Fiyat: ${price.toFixed(2)}`;
      if (prevClose !== null) {
        const change = ((price - prevClose) / prevClose) * 100;
        const sign = change >= 0 ? "+" : "";
        document.getElementById("priceChange").innerText = `DeÄŸiÅŸim: ${sign}${change.toFixed(2)}%`;
      }
      if (time !== null) {
        const date = new Date(time * 1000);
        document.getElementById("candleTime").innerText = `Zaman: ${date.toLocaleString()}`;
      }
    }

    // === Kontroller ===
    function changeInterval(interval) { currentInterval = interval; liveMode ? startLive(interval) : startReplay(interval); }
    function toggleMode() { liveMode ? startReplay(currentInterval) : startLive(currentInterval); liveMode = !liveMode; }
    function changeSymbol(symbol) { currentSymbol = symbol; liveMode ? startLive(currentInterval) : startReplay(currentInterval); }
    function updateReplaySpeed(speed) { replaySpeed = parseFloat(speed); if (!liveMode) startReplay(currentInterval); }
    function toggleEMA() { showEMA = document.getElementById("toggleEMA").checked; liveMode ? startLive(currentInterval) : startReplay(currentInterval); }
    function toggleSMA() { showSMA = document.getElementById("toggleSMA").checked; liveMode ? startLive(currentInterval) : startReplay(currentInterval); }

    function cleanup() {
      if (socket) { socket.onclose = null; socket.close(); socket = null; }
      if (chart) { chart.remove(); chart = null; candleSeries = null; }
      if (replayTimer) { clearInterval(replayTimer); replayTimer = null; }
      lastPriceLine = null;
    }

    window.addEventListener("resize", () => {
      if (chart) chart.applyOptions({ width: window.innerWidth, height: window.innerHeight - 60 - 40 });
    });

    startLive(currentInterval);
  </script>
</body>
</html>
